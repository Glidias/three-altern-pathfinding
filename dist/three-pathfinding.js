var e=function(){};e.computeCentroids=function(t){var n,r,o;for(n=0,r=t.faces.length;n<r;n++)(o=t.faces[n]).centroid=new e.Vec3Constructor(0,0,0),o.centroid.add(t.vertices[o.a]),o.centroid.add(t.vertices[o.b]),o.centroid.add(t.vertices[o.c]),o.centroid.divideScalar(3)},e.roundNumber=function(e,t){return Number(e.toFixed(t))},e.sample=function(e){return e[Math.floor(Math.random()*e.length)]},e.mergeVertexIds=function(e,t){var n=[];if(e.forEach(function(e){t.indexOf(e)>=0&&n.push(e)}),n.length<2)return[];n.includes(e[0])&&n.includes(e[e.length-1])&&e.push(e.shift()),n.includes(t[0])&&n.includes(t[t.length-1])&&t.push(t.shift()),n=[],e.forEach(function(e){t.includes(e)&&n.push(e)});for(var r=n[1],o=n[0],i=e.slice();i[0]!==r;)i.push(i.shift());for(var s=0,c=t.slice();c[0]!==o;)if(c.push(c.shift()),s++>10)throw new Error("Unexpected state");return c.shift(),c.pop(),i=i.concat(c)},e.setPolygonCentroid=function(t,n){var r=new e.Vec3Constructor,o=n.vertices;t.vertexIds.forEach(function(e){r.add(o[e])}),r.divideScalar(t.vertexIds.length),t.centroid.copy(r)},e.cleanPolygon=function(e,t){for(var n=[],r=t.vertices,o=0;o<e.vertexIds.length;o++){var i,s,c,u=r[e.vertexIds[o]];0===o?(i=e.vertexIds[1],s=e.vertexIds[e.vertexIds.length-1]):o===e.vertexIds.length-1?(i=e.vertexIds[0],s=e.vertexIds[e.vertexIds.length-2]):(i=e.vertexIds[o+1],s=e.vertexIds[o-1]),c=r[s];var h=r[i].clone().sub(u),a=c.clone().sub(u),d=h.angleTo(a);if(d>Math.PI-.01&&d<Math.PI+.01){var f=[];e.neighbours.forEach(function(t){t.vertexIds.includes(e.vertexIds[o])||f.push(t)}),e.neighbours=f}else n.push(e.vertexIds[o])}e.vertexIds=n,this.setPolygonCentroid(e,t)},e.isConvex=function(e,t){var n=t.vertices;if(e.vertexIds.length<3)return!1;for(var r=!0,o=[],i=0;i<e.vertexIds.length;i++){var s,c,u=n[e.vertexIds[i]];0===i?(s=n[e.vertexIds[1]],c=n[e.vertexIds[e.vertexIds.length-1]]):i===e.vertexIds.length-1?(s=n[e.vertexIds[0]],c=n[e.vertexIds[e.vertexIds.length-2]]):(s=n[e.vertexIds[i+1]],c=n[e.vertexIds[i-1]]);var h=s.clone().sub(u),a=c.clone().sub(u),d=h.angleTo(a);if(d===Math.PI||0===d)return!1;var f=h.cross(a).y;o.push(f)}return o.forEach(function(e){0===e&&(r=!1)}),o.forEach(o[0]>0?function(e){e<0&&(r=!1)}:function(e){e>0&&(r=!1)}),r},e.distanceToSquared=function(e,t){var n=e.x-t.x,r=e.y-t.y,o=e.z-t.z;return n*n+r*r+o*o},e.isPointInPoly=function(e,t){for(var n=!1,r=-1,o=e.length,i=o-1;++r<o;i=r)(e[r].z<=t.z&&t.z<e[i].z||e[i].z<=t.z&&t.z<e[r].z)&&t.x<(e[i].x-e[r].x)*(t.z-e[r].z)/(e[i].z-e[r].z)+e[r].x&&(n=!n);return n},e.isVectorInPolygon=function(e,t,n){var r=1e5,o=-1e5,i=[];return t.vertexIds.forEach(function(e){r=Math.min(n[e].y,r),o=Math.max(n[e].y,o),i.push(n[e])}),!!(e.y<o+.5&&e.y>r-.5&&this.isPointInPoly(i,e))},e.triarea2=function(e,t,n){return(n.x-e.x)*(t.z-e.z)-(t.x-e.x)*(n.z-e.z)},e.vequal=function(e,t){return this.distanceToSquared(e,t)<1e-5},e.Vec3Constructor=window.THREE?THREE.Vector3:null;var t=function(e){this.content=[],this.scoreFunction=e};t.prototype.push=function(e){this.content.push(e),this.sinkDown(this.content.length-1)},t.prototype.pop=function(){var e=this.content[0],t=this.content.pop();return this.content.length>0&&(this.content[0]=t,this.bubbleUp(0)),e},t.prototype.remove=function(e){var t=this.content.indexOf(e),n=this.content.pop();t!==this.content.length-1&&(this.content[t]=n,this.scoreFunction(n)<this.scoreFunction(e)?this.sinkDown(t):this.bubbleUp(t))},t.prototype.size=function(){return this.content.length},t.prototype.rescoreElement=function(e){this.sinkDown(this.content.indexOf(e))},t.prototype.sinkDown=function(e){for(var t=this.content[e];e>0;){var n=(e+1>>1)-1,r=this.content[n];if(!(this.scoreFunction(t)<this.scoreFunction(r)))break;this.content[n]=t,this.content[e]=r,e=n}},t.prototype.bubbleUp=function(e){for(var t=this.content.length,n=this.content[e],r=this.scoreFunction(n);;){var o=e+1<<1,i=o-1,s=null,c=void 0;if(i<t)(c=this.scoreFunction(this.content[i]))<r&&(s=i);if(o<t)this.scoreFunction(this.content[o])<(null===s?r:c)&&(s=o);if(null===s)break;this.content[e]=this.content[s],this.content[s]=n,e=s}};var n=function(){};n.init=function(e){for(var t=0;t<e.length;t++){var n=e[t];n.f=0,n.g=0,n.h=0,n.cost=1,n.visited=!1,n.closed=!1,n.parent=null}},n.cleanUp=function(e){for(var t=0;t<e.length;t++){var n=e[t];delete n.f,delete n.g,delete n.h,delete n.cost,delete n.visited,delete n.closed,delete n.parent}},n.heap=function(){return new t(function(e){return e.f})},n.search=function(e,t,n){this.init(e);var r=this.heap();for(r.push(t);r.size()>0;){var o=r.pop();if(o===n){for(var i=o,s=[];i.parent;)s.push(i),i=i.parent;return this.cleanUp(s),s.reverse()}o.closed=!0;for(var c=this.neighbours(e,o),u=0,h=c.length;u<h;u++){var a=c[u];if(!a.closed){var d=o.g+(o.neighbourCosts?o.neighbourCosts[u]:a.cost),f=a.visited;if(!f||d<a.g){if(a.visited=!0,a.parent=o,!a.centroid||!n.centroid)throw new Error("Unexpected state");a.h=a.h||this.heuristic(a.centroid,n.centroid),a.g=d,a.f=a.g+a.h,f?r.rescoreElement(a):r.push(a)}}}}return[]},n.heuristic=function(e,t){var n=t.x-e.x,r=t.y-e.y,o=t.z-e.z;return 2.5*Math.sqrt(n*n+r*r+o*o)},n.neighbours=function(e,t){for(var n=[],r=0;r<t.neighbours.length;r++)n.push(e[t.neighbours[r]]);return n};var r=1,o=function(){};o.buildZone=function(t){var n=this,r=this._buildNavigationMesh(t),o={};r.vertices.forEach(function(t){t.x=e.roundNumber(t.x,2),t.y=e.roundNumber(t.y,2),t.z=e.roundNumber(t.z,2)}),o.vertices=r.vertices;var i=this._buildPolygonGroups(r);o.groups=[];var s=function(e,t){for(var n=0;n<e.length;n++)if(t===e[n])return n};return i.forEach(function(t){var r=[];t.forEach(function(o){var i=o.neighbours.map(function(e){return s(t,e)}),c=o.neighbours.map(function(e){return n._getSharedVerticesInOrder(o,e)});o.centroid.x=e.roundNumber(o.centroid.x,2),o.centroid.y=e.roundNumber(o.centroid.y,2),o.centroid.z=e.roundNumber(o.centroid.z,2),r.push({id:s(t,o),neighbours:i,neighbourCosts:o.neighbourCosts,vertexIds:o.vertexIds,centroid:o.centroid,portals:c})}),o.groups.push(r)}),o},o._buildNavigationMesh=function(t){return t.faces&&e.computeCentroids(t),t.mergeVertices&&t.mergeVertices(),this._buildPolygonsFromGeometry(t)},o._buildPolygonGroups=function(e){var t=[],n=0,r=function(e){e.neighbours.forEach(function(t){void 0===t.group&&(t.group=e.group,r(t))})};return e.polygons.forEach(function(e){void 0===e.group&&(e.group=n++,r(e)),t[e.group]||(t[e.group]=[]),t[e.group].push(e)}),t},o._buildPolygonNeighbours=function(e,t,n){var r=new Set,o=n.get(e.vertexIds[0]),i=n.get(e.vertexIds[1]),s=n.get(e.vertexIds[2]);o.forEach(function(e){(i.has(e)||s.has(e))&&r.add(t.polygons[e])}),i.forEach(function(e){s.has(e)&&r.add(t.polygons[e])}),e.neighbours=Array.from(r),e.neighbourCosts=this._getCostsOfNeighboursFromCentroid(e.neighbours,e.centroid)},o._getCostsOfNeighboursFromCentroid=function(e,t){return e.map(function(e){var n=e.centroid.x-t.x,r=e.centroid.y-t.y,o=e.centroid.z-t.z;return Math.sqrt(n*n+r*r+o*o)})},o._alternCentroidFromVerticesIndices=function(t,n,r,o){var i=t[(n*=3)+1],s=t[n+2],c=t[(r*=3)+2];return new e.Vec3Constructor((n=t[n]+t[r]+t[o*=3])/3,(r=i+t[r+1]+t[o+1])/3,(o=s+c+t[o+2])/3)},o._buildPolygonsFromGeometry=function(t){for(var n=this,o=[],s=t.vertices,c=t.indices?t.vertices.length/3:s.length,u=new Map,h=0;h<c;h++)u.set(h,new Set);if(t.indices){for(i=0;i<t.indices.length;i+=3)o.push({id:r++,vertexIds:[t.indices[i],t.indices[i+1],t.indices[i+2]],centroid:n._alternCentroidFromVerticesIndices(t.vertices,t.indices[i],t.indices[i+1],t.indices[i+2]),neighbours:[]}),u.get(t.indices[i]).add(o.length-1),u.get(t.indices[i+1]).add(o.length-1),u.get(t.indices[i+2]).add(o.length-1);var a=[];for(i=0;i<t.vertices.length;i+=3)a.push(new e.Vec3Constructor(t.vertices[i],t.vertices[i+1],t.vertices[i+2]));s=a}else t.faces.forEach(function(e){o.push({id:r++,vertexIds:[e.a,e.b,e.c],centroid:e.centroid,neighbours:[]}),u.get(e.a).add(o.length-1),u.get(e.b).add(o.length-1),u.get(e.c).add(o.length-1)});var d={polygons:o,vertices:s};return o.forEach(function(e){n._buildPolygonNeighbours(e,d,u)}),d},o._getSharedVerticesInOrder=function(e,t){var n=e.vertexIds,r=t.vertexIds,o=new Set;if(n.forEach(function(e){r.includes(e)&&o.add(e)}),o.size<2)return[];o.has(n[0])&&o.has(n[n.length-1])&&n.push(n.shift()),o.has(r[0])&&o.has(r[r.length-1])&&r.push(r.shift());var i=[];return n.forEach(function(e){r.includes(e)&&i.push(e)}),i};var i=function(){this.portals=[]};i.prototype.push=function(e,t){void 0===t&&(t=e),this.portals.push({left:e,right:t})},i.prototype.stringPull=function(){var t,n,r,o=this.portals,i=[],s=0,c=0,u=0;n=o[0].left,r=o[0].right,i.push(t=o[0].left);for(var h=1;h<o.length;h++){var a=o[h].left,d=o[h].right;if(e.triarea2(t,r,d)<=0){if(!(e.vequal(t,r)||e.triarea2(t,n,d)>0)){i.push(n),n=t=n,r=t,c=s=c,u=s,h=s;continue}r=d,u=h}if(e.triarea2(t,n,a)>=0){if(!(e.vequal(t,n)||e.triarea2(t,r,a)<0)){i.push(r),n=t=r,r=t,c=s=u,u=s,h=s;continue}n=a,c=h}}return 0!==i.length&&e.vequal(i[i.length-1],o[o.length-1].left)||i.push(o[o.length-1].left),this.path=i,i};var f=function(){this.zones={}};f.setVec3Constructor=function(t){e.Vec3Constructor=t},f.createZone=function(e){return e.isGeometry?console.warn("[three-pathfinding]: Use THREE.BufferGeometry, not THREE.Geometry, to create zone."):e=e.indices?e:(new THREE.Geometry).fromBufferGeometry(e),o.buildZone(e)},f.prototype.setZoneData=function(e,t){this.zones[e]=t},f.prototype.getGroup=function(t,n){if(!this.zones[t])return null;var r=null,o=Math.pow(50,2);return this.zones[t].groups.forEach(function(t,i){t.forEach(function(t){var s=e.distanceToSquared(t.centroid,n);s<o&&(r=i,o=s)})}),r},f.prototype.getRandomNode=function(t,n,r,o){if(!this.zones[t])return new e.Vec3Constructor;r=r||null,o=o||0;var i=[];return this.zones[t].groups[n].forEach(function(t){r&&o?e.distanceToSquared(r,t.centroid)<o*o&&i.push(t.centroid):i.push(t.centroid)}),e.sample(i)||new e.Vec3Constructor},f.prototype.getClosestNode=function(t,n,r,o){void 0===o&&(o=!1);var i=this.zones[n].vertices,s=null,c=Infinity;return this.zones[n].groups[r].forEach(function(n){var r=e.distanceToSquared(n.centroid,t);r<c&&(!o||e.isVectorInPolygon(t,n,i))&&(s=n,c=r)}),s},f.prototype.findPath=function(t,r,o,s){var c=this.zones[o].groups[s],u=this.zones[o].vertices,h=this.getClosestNode(t,o,s),a=this.getClosestNode(r,o,s,!0);if(!h||!a)return null;var d=n.search(c,h,a),f=function(e,t){for(var n=0;n<e.neighbours.length;n++)if(e.neighbours[n]===t.id)return e.portals[n]},l=new i;l.push(t);for(var v=0;v<d.length;v++){var g=d[v+1];if(g){var p=f(d[v],g);l.push(u[p[0]],u[p[1]])}}l.push(r),l.stringPull();var x=l.path.map(function(t){return new e.Vec3Constructor(t.x,t.y,t.z)});return x.shift(),x},exports.Pathfinding=f;
//# sourceMappingURL=three-pathfinding.js.map
